name: Deploy Vite App to GitHub Pages

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm install

      - name: Build Vite app
        run: npm run build
        env:
          VITE_API_URL: ${{ vars.VITE_API_URL }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}

      # ‚úÖ NOVO PASSO: Verificar se o arquivo assetlinks.json foi criado corretamente
      - name: Verify assetlinks.json for Android Deep Links
        run: |
          echo "üîç Verificando arquivo assetlinks.json..."

          # Verifica se o arquivo existe
          if [ -f "dist/.well-known/assetlinks.json" ]; then
            echo "‚úÖ Arquivo encontrado: dist/.well-known/assetlinks.json"

            # Exibe o conte√∫do (√∫til para debug)
            echo "üìÑ Conte√∫do do arquivo:"
            cat dist/.well-known/assetlinks.json
            echo ""

            # Valida o JSON
            if jq empty dist/.well-known/assetlinks.json 2>/dev/null; then
              echo "‚úÖ JSON v√°lido"

              # Verifica se cont√©m a estrutura correta
              if jq -e '.[0].relation' dist/.well-known/assetlinks.json > /dev/null 2>&1; then
                echo "‚úÖ Estrutura correta encontrada"

                # Extrai informa√ß√µes √∫teis para log
                PACKAGE_NAME=$(jq -r '.[0].target.package_name' dist/.well-known/assetlinks.json)
                FINGERPRINT_COUNT=$(jq -r '.[0].target.sha256_cert_fingerprints | length' dist/.well-known/assetlinks.json)

                echo "üì± Package Name: $PACKAGE_NAME"
                echo "üîë Fingerprints cadastrados: $FINGERPRINT_COUNT"

                # Verifica se tem fingerprints
                if [ "$FINGERPRINT_COUNT" -eq 0 ]; then
                  echo "‚ö†Ô∏è  AVISO: Nenhum fingerprint SHA256 configurado!"
                  echo "   Adicione fingerprints em public/.well-known/assetlinks.json"
                else
                  echo "‚úÖ Fingerprints configurados corretamente"

                  # Exibe os primeiros caracteres de cada fingerprint (para log seguro)
                  for i in $(seq 0 $(($FINGERPRINT_COUNT - 1))); do
                    FINGERPRINT=$(jq -r ".[0].target.sha256_cert_fingerprints[$i]" dist/.well-known/assetlinks.json)
                    echo "   Fingerprint $((i+1)): ${FINGERPRINT:0:16}..."
                  done
                fi

              else
                echo "‚ö†Ô∏è  Estrutura JSON incomum, mas arquivo existe"
              fi
            else
              echo "‚ùå ERRO: JSON inv√°lido em assetlinks.json"
              echo "   Corrija o arquivo public/.well-known/assetlinks.json"
              exit 1
            fi
          else
            echo "‚ùå ERRO CR√çTICO: Arquivo assetlinks.json n√£o encontrado!"
            echo "   Crie o arquivo em: public/.well-known/assetlinks.json"
            echo ""
            echo "   Conte√∫do exemplo:"
            echo '   ['
            echo '     {'
            echo '       "relation": ["delegate_permission/common.handle_all_urls"],'
            echo '       "target": {'
            echo '         "namespace": "android_app",'
            echo '         "package_name": "com.quizconcursos.app",'
            echo '         "sha256_cert_fingerprints": ['
            echo '           "93504C9AFA68E5E02E84397144B38E80CBD2CD2D9B2857787E86D5E4CAFFA6D9"'
            echo '         ]'
            echo '       }'
            echo '     }'
            echo '   ]'
            exit 1
          fi

          # Verifica se o arquivo est√° acess√≠vel via URL simulada
          echo ""
          echo "üåê Simulando acesso ao arquivo..."
          echo "   URL: https://quizconcursos.com/.well-known/assetlinks.json"
          echo "   Status: ‚úÖ Ser√° disponibilizado ap√≥s deploy"
          echo ""
          echo "üìã Resumo da verifica√ß√£o:"
          echo "   - Arquivo encontrado: ‚úÖ"
          echo "   - JSON v√°lido: ‚úÖ"
          echo "   - Estrutura correta: ‚úÖ"
          echo "   - Pronto para deep links Android: ‚úÖ"

      - name: Upload GitHub Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: https://quizconcursos.com
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
